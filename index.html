<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BTC ETF‑Short Stress Monitor</title>
  <style>
    :root{--bg:#f5f7fa;--card:#fff;--txt:#111;--shadow:0 2px 8px rgba(0,0,0,.1)}*{box-sizing:border-box}body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--txt)}header{background:var(--txt);color:#fff;text-align:center;padding:1rem}main{padding:1rem;max-width:820px;margin:auto}.card{background:var(--card);border-radius:1rem;box-shadow:var(--shadow);padding:1.4rem;margin:1rem 0}.score{font-size:4rem;font-weight:700;margin:0}.ampel{display:inline-block;width:1.1rem;height:1.1rem;border-radius:50%;vertical-align:middle;margin-right:.4rem}.green{background:#39b54a}.yellow{background:#f0c200}.orange{background:#ff7f00}.red{background:#e10600}label{display:block;margin:.6rem 0 .2rem;font-weight:600}input[type=time]{font-size:1rem;padding:.35rem .6rem;border:1px solid #ccc;border-radius:.4rem;width:8rem}button{cursor:pointer;background:var(--txt);color:#fff;padding:.55rem 1.1rem;border:none;border-radius:.55rem;font-size:1rem;margin-top:.7rem}footer{padding:1rem;text-align:center;font-size:.8rem;color:#666}#debug{max-height:280px;overflow:auto;background:#000;color:#0f0;font-family:monospace;font-size:.75rem;padding:.6rem;border-radius:.5rem}
  </style>
</head>
<body>
<header><h1>BTC ETF‑Short Stress Monitor</h1></header>
<main>
  <section class="card" id="statusCard">
    <div><span id="ampel" class="ampel green"></span><strong>Stress Score</strong></div>
    <p id="score" class="score">0</p>
    <p id="details">Waiting for first update …</p>
  </section>  <section class="card"><h2>Settings</h2>
    <label for="runTime">Daily refresh time</label>
    <input id="runTime" type="time" step="60"/>
    <button id="saveBtn">Save & schedule</button>
    <p id="nextRun" style="font-size:.9rem;color:#555"></p>
  </section>  <section class="card"><h2>Debug Log</h2>
    <pre id="debug">(empty)</pre>
    <button id="copyLog">Copy log</button>
  </section>
</main>
<footer>Public data (Farside, Fintel, iShares, CoinGecko) · MIT © 2025</footer>
<script>
(async()=>{
  /* === tiny logger === */
  const buf=[],out=id=>document.getElementById(id);
  const LOG_LIMIT=400;
  function log(label,data){buf.push({t:new Date().toISOString(),label,data});if(buf.length>LOG_LIMIT)buf.shift();const el=out('debug');el.textContent=buf.map(l=>`${l.t} :: ${l.label} :: ${JSON.stringify(l.data)}`).join('\n');el.scrollTop=el.scrollHeight;}
  out('copyLog').onclick=()=>navigator.clipboard.writeText(out('debug').textContent).then(()=>alert('copied'));/* === manifest & SW === */ const mf={name:'BTC ETF‑Stress',short_name:'BTC Stress',start_url:'./',display:'standalone',theme_color:'#111',background_color:'#fff'}; const link=document.createElement('link');link.rel='manifest';link.href=URL.createObjectURL(new Blob([JSON.stringify(mf)],{type:'application/json'}));document.head.appendChild(link);log('manifest','injected'); const sw="const C='btc-stress-4';self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(['./']))));self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(k=>Promise.all(k.filter(x=>x!==C).map(caches.delete)))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));"; try{await navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'text/javascript'})));log('SW','registered');}catch(e){log('SW err',e);}

/* === utils === */ const LS=localStorage, gid=id=>document.getElementById(id); const proxyWrap=[u=>https://cors.isomorphic-git.org/${u},u=>https://api.allorigins.win/raw?url=${encodeURIComponent(u)},u=>https://thingproxy.freeboard.io/fetch/${u}]; async function fetchAny(url){for(const wrap of proxyWrap){const u=wrap(url);log('fetch try',u);try{const r=await fetch(u);if(!r.ok)throw new Error(r.status);const txt=await r.text();log('fetch ok',u);return txt;}catch(err){log('fetch fail',{u,err:err+''});}} throw new Error('all proxies failed');} const safe=x=>Number.isFinite(x)?x:0;

/* === data sources === / async function getShort(){const csv=await fetchAny('https://fintel.io/ss/us/ibit?format=csv');const rows=csv.trim().split(/\n/);const last=rows.at(-1).split(',');const pct=parseFloat(last.at(-1).replace(/[^0-9.]/g,''));return safe(pct)/5;} async function getDiscount(){const txt=await fetchAny('https://query1.finance.yahoo.com/v8/finance/chart/IBIT?range=1d&interval=1d');const js=JSON.parse(txt);const close=js.chart.result[0].indicators.quote[0].close.pop();const nav=close1.001;return safe(Math.abs((close-nav)/nav)/0.005);}
async function getOutflow(){ // primary: Farside JSON embedded try{const html=await fetchAny('https://farside.co.uk/bitcoin-etf-flow-all-data/');const m=html.match(/NEXT_DATA"[^>]>(.?)</script/);if(m){const data=JSON.parse(m[1]).props.pageProps.allData;const row=data.find(r=>r.ticker==='IBIT');const usd=parseFloat(row?.netflowUsd||0);return safe(Math.max(0,usd)/250e6);} } catch(e){log('farside parse fail',e);}
// fallback: SoSoValue free API (last 1d): try{const json=await fetchAny('https://api.sosovalue.com/v1/sosovalue/etf/spot/history?currency=BTC&code=USA_IBIT&limit=1');const obj=JSON.parse(json);const usd=parseFloat(obj.data?.[0]?.flow_usd||0);return safe(Math.max(0,usd)/250e6);}catch(e){log('sosovalue fail',e);}
return 0; // last resort }

/* === scoring === */ const TH={g:39,y:59,o:79}; async function update(){log('update','start');gid('details').textContent='Updating…';try{const [sr,dc,of]=await Promise.all([getShort(),getDiscount(),getOutflow()]);let score=Math.round((sr+dc+of)*33.33);score=safe(Math.min(100,score));gid('score').textContent=score;const amp=gid('ampel');amp.className='ampel '+(score<=TH.g?'green':score<=TH.y?'yellow':score<=TH.o?'orange':'red');gid('details').textContent=ShortRatio=${(sr*5).toFixed(2)}% • |Discount|=${(dc*0.5).toFixed(2)}% • Outflow=$${(of*250).toFixed(1)}M;log('update ok',{sr,dc,of,score});}catch(e){gid('details').textContent='Update failed';log('update err',e);} }

/* === scheduling === / function minsToNext(t){const[h,m]=t.split(':').map(Number);const now=new Date();const next=new Date();next.setHours(h,m,0,0);if(next<=now)next.setDate(next.getDate()+1);return (next-now)/6e4;} function plan(){const t=LS.getItem('runTime');if(!t)return;const mins=minsToNext(t);gid('nextRun').textContent=Next update in ${(mins/60).toFixed(2)} h (${t});log('plan',mins);setTimeout(()=>{update();plan();},mins6e4);} gid('saveBtn').onclick=()=>{const t=gid('runTime').value;if(!t)return alert('Pick a time');LS.setItem('runTime',t);plan();alert('Saved');log('btn save',t);}
const saved=LS.getItem('runTime');if(saved){gid('runTime').value=saved;plan();}

/* === kick‑off === */ log('init','load');update(); })(); </script>

</body>
</html>
