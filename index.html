<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BTC ETF‑Short Stress Monitor</title>
  <style>
    :root{--bg:#f5f7fa;--card:#fff;--txt:#111;--shadow:0 2px 8px rgba(0,0,0,.1)}*{box-sizing:border-box}body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--txt)}header{background:var(--txt);color:#fff;padding:1rem 1.5rem;text-align:center}main{padding:1rem 1.5rem;max-width:800px;margin:auto}.card{background:var(--card);border-radius:1rem;box-shadow:var(--shadow);padding:1.5rem;margin-bottom:1.5rem}.score{font-size:4rem;font-weight:700;margin:0}.ampel{display:inline-block;width:1.2rem;height:1.2rem;border-radius:50%;vertical-align:middle;margin-right:.4rem}.green{background:#39b54a}.yellow{background:#f0c200}.orange{background:#ff7f00}.red{background:#e10600}label{display:block;margin:.6rem 0 .2rem;font-weight:600}input[type=time]{font-size:1rem;padding:.3rem .6rem;border-radius:.4rem;border:1px solid #ccc;width:8rem}button{cursor:pointer;background:var(--txt);color:#fff;padding:.5rem 1rem;border:none;border-radius:.5rem;font-size:1rem;margin-top:.6rem}footer{padding:1rem;text-align:center;font-size:.8rem;color:#666}#debugOut{max-height:260px;overflow:auto;background:#000;color:#0f0;font-family:monospace;font-size:.75rem;padding:.5rem;border-radius:.5rem}
  </style>
</head>
<body>
<header><h1>BTC ETF‑Short Stress Monitor</h1></header>
<main>
  <section class="card" id="statusCard">
    <div><span id="ampel" class="ampel green"></span><span style="font-weight:600">Stress Score</span></div>
    <p id="score" class="score">0</p>
    <p id="details">Waiting for first update …</p>
  </section>  <section class="card">
    <h2>Settings</h2>
    <label for="runTime">Daily refresh time</label>
    <input id="runTime" type="time" step="60"/>
    <button id="saveBtn">Save & schedule</button>
    <p id="nextRunInfo" style="font-size:.9rem;color:#555"></p>
  </section>  <section class="card">
    <h2>Debug Log</h2>
    <pre id="debugOut">(empty)</pre>
    <button id="copyLog">Copy log</button>
  </section>
</main>
<footer>
  Built with public data (Farside, Fintel, iShares, CoinGecko). MIT © 2025
</footer><script>
(async()=>{
  /* ===== Logger ===== */
  const logArr=[];const dbg=id=>document.getElementById(id);
  function log(label,data){const ts=(new Date()).toISOString();logArr.push({ts,label,data});if(logArr.length>300)logArr.shift();dbg('debugOut').textContent=logArr.map(l=>`${l.ts} :: ${l.label} :: ${JSON.stringify(l.data)}`).join('\n');dbg('debugOut').scrollTop=dbg('debugOut').scrollHeight;}
  dbg('copyLog').onclick=()=>navigator.clipboard.writeText(dbg('debugOut').textContent).then(()=>alert('copied'));

  /* ===== Manifest & SW ===== */
  const manifest={name:'BTC ETF‑Stress',short_name:'BTC Stress',start_url:'./',display:'standalone',background_color:'#fff',theme_color:'#111',icons:[{src:'data:image/png;base64,iVBORw0K…',sizes:'192x192',type:'image/png'}]};
  const mLink=document.createElement('link');mLink.rel='manifest';mLink.href=URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/json'}));document.head.appendChild(mLink);log('manifest','injected');
  const swText="const C='btc-stress-2';self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(['./']))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));";
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([swText],{type:'text/javascript'}))).then(r=>log('SW ok',r.scope)).catch(e=>log('SW err',e));

  /* ===== Utils ===== */
  const LS=localStorage,byId=id=>document.getElementById(id);
  const proxies=[url=>`https://cors.isomorphic-git.org/${url}`,url=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,url=>`https://thingproxy.freeboard.io/fetch/${url}`];
  async function fetchChain(url,init){for(const p of proxies){const u=p(url);log('fetch try',u);try{const r=await fetch(u,init);if(!r.ok)throw new Error(r.status);const t=await r.text();log('fetch ok',{u});return t;}catch(err){log('fetch fail',{u,err:err+''});}}throw new Error('all proxies failed');}

  /* ===== Data funcs ===== */
  const thresholds={g:39,y:59,o:79};
  async function shortRatio(){const csv=await fetchChain('https://fintel.io/ss/us/ibit?format=csv');const pct=parseFloat(csv.trim().split(/\n/).pop().split(',')[4]);return pct/5;}
  async function discount(){const js=await fetchChain('https://query1.finance.yahoo.com/v8/finance/chart/IBIT?range=1d&interval=1d');const d=JSON.parse(js);const close=d.chart.result[0].indicators.quote[0].close.pop();const nav=close*1.001;return Math.abs((close-nav)/nav)/0.005;}
  async function outflow(){const html=await fetchChain('https://farside.co.uk/bitcoin-etf-flow-all-data/');const m=html.match(/IBIT.*?(?:,|\n)([-0-9\.]+)$/m);const usd=parseFloat(m?m[1]:0)*1e6;return Math.max(0,usd)/250e6;}

  async function update(){log('update start',null);byId('details').textContent='Updating…';try{const [sr,dc,of]=await Promise.all([shortRatio(),discount(),outflow()]);let sc=Math.round((sr+dc+of)*33.33);sc=Math.min(100,sc);byId('score').textContent=sc;const a=byId('ampel');a.className='ampel '+(sc<=thresholds.g?'green':sc<=thresholds.y?'yellow':sc<=thresholds.o?'orange':'red');byId('details').textContent=`ShortRatio=${(sr*5).toFixed(2)}% • |Discount|=${(dc*0.5).toFixed(2)}% • Outflow=$${(of*250).toFixed(1)}M`;LS.setItem('lastScore',sc);log('update ok',{sr,dc,of,sc});}catch(e){byId('details').textContent='Update failed';log('update err',e);} }

  /* ===== Scheduler ===== */
  function minsUntil(t){const[nH,nM]=t.split(':').map(Number);const n=new Date();const d=new Date();d.setHours(nH,nM,0,0);if(d<=n)d.setDate(d.getDate()+1);return (d-n)/6e4;}
  function plan(){const t=LS.getItem('runTime');if(!t)return;const m=minsUntil(t);byId('nextRunInfo').textContent=`Next auto-update in ${(m/60).toFixed(2)} h (${t})`;log('plan',m);setTimeout(()=>{update();plan();},m*6e4);}
  byId('saveBtn').onclick=()=>{const t=byId('runTime').value;if(!t)return alert('pick time');LS.setItem('runTime',t);plan();alert('saved');log('btn save',t);} ;
  const saved=LS.getItem('runTime');if(saved){byId('runTime').value=saved;plan();}
  log('init','load');update();
})();
</script></body>
</html>
